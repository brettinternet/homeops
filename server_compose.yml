---
# TODO: configure rootless docker https://wiki.archlinux.org/index.php/Docker#Docker_rootless

# TODO: update Traefik to v2 https://github.com/klutchell/mediaserver

- name: Setup docker compose services
  hosts: server
  vars_files:
    - "{{ playbook_dir }}/vars/secret.yml"
  vars:
    runtime_dir: "{{ ansible_facts['user_dir'] }}/apps"
    # `present` is "up" and `absent` is "down"
    compose_state: present

  tasks:
    ### Configure compose files ###

    - name: Create runtime directory
      file:
        dest: "{{ runtime_dir }}"
        state: directory
        mode: 0744

    - name: Copy orchestration files
      copy:
        src: "{{ playbook_dir }}/files/{{ item }}"
        dest: "{{ runtime_dir }}/"
        mode: 0744
      with_items:
        - docker-compose.yml
        - docker-compose.override.yml

    - name: Create docker-compose environment file
      template:
        # TODO: can simplify directory? relative?
        src: "{{ playbook_dir }}/templates/env.j2"
        dest: "{{ runtime_dir }}/.env"
        mode: 0700

    ### Rootless Docker configuration ###
    # https://wiki.archlinux.org/index.php/Docker#Docker_rootless
    # https://docs.docker.com/engine/security/rootless/

    - name: Configure /etc/subuid
      become: yes
      ansible.builtin.lineinfile:
        path: /etc/subuid
        line: "{{ ansible_user }}:231072:65536"
        create: yes

    - name: Configure /etc/subgid
      become: yes
      ansible.builtin.lineinfile:
        path: /etc/subgid
        line: "{{ ansible_user }}:231072:65536"
        create: yes

    - name: Enable the docker socket
      # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/systemd_module.html
      ansible.builtin.systemd:
        name: docker.socket
        scope: user
        enabled: yes
        state: started

    # - name: Set orchestration state
    #   # https://docs.ansible.com/ansible/latest/collections/community/general/docker_compose_module.html
    #   community.general.docker_compose:
    #     project_src: "{{ runtime_dir }}"
    #     state: " {{ compose_state }}"
    #     docker_host: unix://$XDG_RUNTIME_DIR/docker.sock
