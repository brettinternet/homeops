---
x-options: &options
  profiles: [networking]
  networks: [default]
  environment: &environment
    TZ: "${TIMEZONE}"
  deploy:
    restart_policy: &restart_policy
      condition: unless-stopped

x-media-volume:
  driver_opts: &media_driver_opts
    type: nfs
    o: addr=${MEDIA_IP},hard,timeo=600,retrans=3,proto=tcp,nfsvers=4.2,port=2049,rsize=4096,wsize=4096,noacl,nocto,noatime,nodiratime
    device: :/

volumes:
  media:
    name: media
    driver_opts:
      <<: *media_driver_opts
      device: :/
  media_library:
    name: media_library
    driver_opts:
      <<: *media_driver_opts
      device: :/library
  books:
    name: books
    driver_opts:
      <<: *media_driver_opts
      device: :/library/books
  usenet:
    name: usenet
    driver_opts:
      <<: *media_driver_opts
      device: :/usenet
  cameras:
    name: cameras
    driver_opts:
      <<: *media_driver_opts
      device: :/cameras

services:
  cloudflare-ddns:
    <<: *options
    image: ghcr.io/joshuaavalon/cloudflare-ddns:latest
    environment:
      <<: *environment
      CF_DNS__CRON: "*/10 * * * *"
      CF_DNS__AUTH__SCOPED_TOKEN: "${CLOUDFLARE_API_TOKEN}"
      CF_DNS__DOMAINS_0__ZONE_NAME: "${PRIVATE_DOMAIN}"
      CF_DNS__DOMAINS_0__ZONE_ID: "${CLOUDFLARE_PRIVATE_DOMAIN_ZONE_ID}"
      CF_DNS__DOMAINS_0__NAME: "local.${PRIVATE_DOMAIN}"
      CF_DNS__DOMAINS_0__PROXIED: "false"
      CF_DNS__DOMAINS_0__CREATE: "true"
      CF_DNS__DOMAINS_0__TYPE: A

  unifi_mongo:
    <<: *options
    image: mongo:7
    volumes:
      - "${CONFIG_DIR}/unifi_mongo/db:/data/db"
      - "${CONFIG_DIR}/unifi_mongo/init-mongo.js:/docker-entrypoint-initdb.d/init-mongo.js:ro"

  nfs-shared:
    <<: *options
    image: itsthenetwork/nfs-server-alpine:latest
    cap_add: [SYS_ADMIN, SETPCAP]
    environment:
      <<: *environment
      SHARED_DIRECTORY: /shared
    volumes:
      - "${SHARED_DIR}:/shared"
    ports:
      - 2049:2049
    deploy:
      restart_policy: *restart_policy
      placement:
        constraints:
          - node.hostname == "${CONFIG_HOSTNAME}"

  smb:
    <<: *options
    image: dperson/samba:latest
    environment:
      <<: *environment
      SHARE: "shared;/shared;yes;no;yes;;;;"
      USERID: "${PUID}"
      GROUPID: "${PGID}"
    volumes:
      - "${SHARED_DIR}:/shared"
    ports:
      - 139:139
      - 445:445
    deploy:
      restart_policy: *restart_policy
      placement:
        constraints:
          - node.hostname == "${CONFIG_HOSTNAME}"
