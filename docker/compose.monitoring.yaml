---
x-options: &options
  profiles: [monitoring]
  networks: [default]
  environment: &environment
    TZ: "${TIMEZONE}"
  deploy:
    restart_policy:
      condition: unless-stopped

services:
  healthchecks:
    <<: *options
    image: lscr.io/linuxserver/healthchecks
    environment:
      <<: *environment
      PUID: "${PUID}"
      PGID: "${PGID}"
      SITE_ROOT: "https://healthchecks.${PUBLIC_DOMAIN}"
      SITE_NAME: Healthchecks
      DEFAULT_FROM_EMAIL: "${SMTP_USER}"
      EMAIL_HOST: maddy
      EMAIL_PORT: 25
      EMAIL_USE_TLS: "False"
      SUPERUSER_EMAIL: "${HEALTHCHECKS_ADMIN_EMAIL}"
      SUPERUSER_PASSWORD: "${HEALTHCHECKS_ADMIN_PASSWORD}"
      SECRET_KEY: "${HEALTHCHECKS_SECRET_KEY}"
      INTEGRATIONS_ALLOW_PRIVATE_IPS: "True"
    volumes:
      - "${CONFIG_DIR}/healthchecks:/config"
    ports:
      - 8000:8000
    labels:
      traefik.enable: "true"
      traefik.http.routers.healthchecks.middlewares: hsts-header
      traefik.http.routers.healthchecks.rule: Host(`healthchecks.${PUBLIC_DOMAIN}`)
      traefik.http.routers.healthchecks.entrypoints: websecure
      traefik.http.services.healthchecks.loadbalancer.server.port: 8000

  smokeping:
    <<: *options
    image: lscr.io/linuxserver/smokeping:latest
    environment:
      <<: *environment
      PUID: "${PUID}"
      PGID: "${PGID}"
    volumes:
      - "${CONFIG_DIR}/smokeping/config:/config"
      - "${CONFIG_DIR}/smokeping/data:/data"
    labels:
      traefik.enable: "true"
      traefik.http.routers.smokeping.middlewares: hsts-header, ipallowlist, authelia_private
      traefik.http.routers.smokeping.rule: Host(`ping.${PRIVATE_DOMAIN}`)
      traefik.http.services.smokeping.loadbalancer.server.port: 80
      traefik.http.routers.smokeping.entrypoints: websecure

  gatus:
    <<: *options
    image: twinproduction/gatus:latest
    depends_on: [gatus_postgres]
    environment:
      <<: *environment
      POSTGRES_HOST: gatus_postgres
      POSTGRES_DB: gatus
      POSTGRES_USER: gatus
      POSTGRES_PASSWORD: "${GATUS_POSTGRES_PASSWORD}"
      NTFY_TOKEN: "${NTFY_GATUS_TOKEN}"
    volumes:
      - "${CONFIG_DIR}/gatus:/config"
    labels:
      traefik.enable: "true"
      traefik.http.routers.gatus.middlewares: hsts-header, ipallowlist, authelia_private
      traefik.http.routers.gatus.rule: Host(`status.${PRIVATE_DOMAIN}`)
      traefik.http.routers.gatus.entrypoints: websecure
      traefik.http.services.gatus.loadbalancer.server.port: 8080

  gatus_postgres:
    <<: *options
    image: postgres:16
    environment:
      <<: *environment
      PGDATA: /var/lib/postgresql/data
      POSTGRES_DB: gatus
      POSTGRES_USER: gatus
      POSTGRES_PASSWORD: "${GATUS_POSTGRES_PASSWORD}"
    volumes:
      - "${CONFIG_DIR}/gatus_postgres:/var/lib/postgresql/data"
