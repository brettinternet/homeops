---
x-service: &service
  profiles: [auth]
  networks: [default]
  environment: &environment
    TZ: "${TIMEZONE}"
  deploy:
    restart_policy:
      condition: unless-stopped

x-authelia-environment: &authelia_environment
  AUTHELIA_LOG_LEVEL: info
  AUTHELIA_JWT_SECRET: "${AUTHELIA_JWT_SECRET}"
  AUTHELIA_AUTHENTICATION_BACKEND_LDAP_PASSWORD: "${AUTHELIA_LDAP_PASSWORD}"
  # AUTHELIA_IDENTITY_PROVIDERS_OIDC_HMAC_SECRET: "${AUTHELIA_OIDC_HMAC_SECRET}"
  # AUTHELIA_IDENTITY_PROVIDERS_OIDC_ISSUER_PRIVATE_KEY: "${AUTHELIA_OIDC_ISSUER_PRIVATE_KEY}"
  AUTHELIA_SESSION_REDIS_HOST: authelia_redis
  AUTHELIA_SESSION_REDIS_PASSWORD: "${AUTHELIA_REDIS_PASSWORD}"
  AUTHELIA_SESSION_REDIS_PORT: 6379
  AUTHELIA_SESSION_SECRET: "${AUTHELIA_SESSION_SECRET}"
  AUTHELIA_STORAGE_ENCRYPTION_KEY: "${AUTHELIA_STORAGE_ENCRYPTION_KEY}"
  AUTHELIA_STORAGE_POSTGRES_HOST: authelia_db
  AUTHELIA_STORAGE_POSTGRES_DATABASE: authelia
  AUTHELIA_STORAGE_POSTGRES_USERNAME: authelia
  AUTHELIA_STORAGE_POSTGRES_PASSWORD: "${AUTHELIA_POSTGRES_PASSWORD}"
  AUTHELIA_NOTIFIER_SMTP_HOST: maddy
  AUTHELIA_NOTIFIER_SMTP_PORT: 25
  AUTHELIA_NOTIFIER_SMTP_SENDER: "Authelia <${SMTP_USER}>"
  AUTHELIA_NOTIFIER_SMTP_DISABLE_REQUIRE_TLS: "true"
  AUTHELIA_AUTHENTICATION_BACKEND_PASSWORD_RESET_DISABLE: "false"
  AUTHELIA_AUTHENTICATION_BACKEND_REFRESH_INTERVAL: 1m
  AUTHELIA_AUTHENTICATION_BACKEND_LDAP_IMPLEMENTATION: custom
  AUTHELIA_AUTHENTICATION_BACKEND_LDAP_URL: ldap://lldap:3890
  AUTHELIA_AUTHENTICATION_BACKEND_LDAP_TIMEOUT: 5s
  AUTHELIA_AUTHENTICATION_BACKEND_LDAP_START_TLS: "false"
  AUTHELIA_AUTHENTICATION_BACKEND_LDAP_BASE_DN: dc=home,dc=arpa
  AUTHELIA_AUTHENTICATION_BACKEND_LDAP_USERNAME_ATTRIBUTE: uid
  AUTHELIA_AUTHENTICATION_BACKEND_LDAP_ADDITIONAL_USERS_DN: ou=people
  AUTHELIA_AUTHENTICATION_BACKEND_LDAP_USERS_FILTER: "(&({username_attribute}={input})(objectClass=person))"
  AUTHELIA_AUTHENTICATION_BACKEND_LDAP_ADDITIONAL_GROUPS_DN: ou=groups
  AUTHELIA_AUTHENTICATION_BACKEND_LDAP_GROUPS_FILTER: (member={dn})
  AUTHELIA_AUTHENTICATION_BACKEND_LDAP_GROUP_NAME_ATTRIBUTE: cn
  AUTHELIA_AUTHENTICATION_BACKEND_LDAP_DISPLAY_NAME_ATTRIBUTE: displayName
  AUTHELIA_AUTHENTICATION_BACKEND_LDAP_MAIL_ATTRIBUTE: mail
  AUTHELIA_AUTHENTICATION_BACKEND_LDAP_USER: cn=admin,ou=people,dc=home,dc=arpa
  AUTHELIA_ACCESS_CONTROL_DEFAULT_POLICY: one_factor
  AUTHELIA_SERVER_TIMEOUTS_READ:

services:
  lldap:
    <<: *service
    image: nitnelave/lldap:latest
    environment:
      <<: *environment
      LLDAP_LDAP_BASE_DN: "dc=home,dc=arpa"
      LLDAP_LDAP_USER_PASS: "${LLDAP_LDAP_USER_PASS}"
      LLDAP_JWT_SECRET: "${LLDAP_JWT_SECRET}"
      UID: "${PUID}"
      GID: "${PGID}"
    volumes:
      - "${CONFIG_DIR}/lldap:/data"
    labels:
      traefik.enable: "true"
      traefik.http.routers.lldap.rule: Host(`ldap.${PRIVATE_DOMAIN}`)
      traefik.http.routers.lldap.entrypoints: websecure
      traefik.http.services.lldap.loadbalancer.server.port: 17170

  authelia_private:
    <<: *service
    image: authelia/authelia:latest
    depends_on: [authelia_db, authelia_redis, lldap]
    environment:
      <<: [*environment, *authelia_environment]
      AUTHELIA_DEFAULT_REDIRECTION_URL: "https://auth.${PRIVATE_DOMAIN}"
      AUTHELIA_SESSION_DOMAIN: "${PRIVATE_DOMAIN}"
    volumes:
      - "${CONFIG_DIR}/authelia/configuration.yaml:/config/configuration.yaml:ro"
    labels:
      traefik.enable: "true"
      traefik.http.routers.authelia_private.middlewares: hsts-header, ipallowlist
      traefik.http.routers.authelia_private.rule: Host(`auth.${PRIVATE_DOMAIN}`)
      traefik.http.services.authelia_private.loadbalancer.server.port: 9091
      traefik.http.routers.authelia_private.entrypoints: websecure
      traefik.http.middlewares.authelia_private.forwardauth.address: http://authelia_private:9091/api/verify?rd=https%3A%2F%2Fauth.${PRIVATE_DOMAIN}%2F
      traefik.http.middlewares.authelia_private.forwardauth.trustForwardHeader: "true"
      traefik.http.middlewares.authelia_private.forwardauth.authResponseHeaders: Remote-User,Remote-Groups,Remote-Name,Remote-Email

  authelia_public:
    <<: *service
    image: authelia/authelia:latest
    depends_on: [authelia_db, authelia_redis, lldap]
    environment:
      <<: [*environment, *authelia_environment]
      AUTHELIA_DEFAULT_REDIRECTION_URL: "https://auth.${PUBLIC_DOMAIN}"
      AUTHELIA_SESSION_DOMAIN: "${PUBLIC_DOMAIN}"
    volumes:
      - "${CONFIG_DIR}/authelia/configuration.yaml:/config/configuration.yaml:ro"
    labels:
      traefik.enable: "true"
      traefik.http.routers.authelia_public.middlewares: hsts-header
      traefik.http.routers.authelia_public.rule: Host(`auth.${PUBLIC_DOMAIN}`)
      traefik.http.services.authelia_public.loadbalancer.server.port: 9091
      traefik.http.routers.authelia_public.entrypoints: websecure
      traefik.http.middlewares.authelia_public.forwardauth.address: http://authelia_public:9091/api/verify?rd=https%3A%2F%2Fauth.${PUBLIC_DOMAIN}%2F
      traefik.http.middlewares.authelia_public.forwardauth.trustForwardHeader: "true"
      traefik.http.middlewares.authelia_public.forwardauth.authResponseHeaders: Remote-User,Remote-Groups,Remote-Name,Remote-Email

  authelia_db:
    <<: *service
    image: library/postgres:14
    environment:
      <<: *environment
      PGDATA: /var/lib/postgresql/data
      POSTGRES_DB: authelia
      POSTGRES_USER: authelia
      POSTGRES_PASSWORD: "${AUTHELIA_POSTGRES_PASSWORD}"
    volumes:
      - "${CONFIG_DIR}/authelia_db:/var/lib/postgresql/data"

  authelia_redis:
    <<: *service
    image: library/redis:7
    environment:
      <<: *environment
      REDIS_PASSWORD: "${AUTHELIA_REDIS_PASSWORD}"
    command: [redis-server, --requirepass, "${AUTHELIA_REDIS_PASSWORD}"]
    volumes:
      - "${CONFIG_DIR}/authelia_redis:/data"
