---
x-service: &service
  profiles: [dev]
  networks: [default]
  environment: &environment
    TZ: "${TIMEZONE}"
  deploy:
    restart_policy:
      condition: unless-stopped

services:
  cgit_public:
    <<: *service
    image: ghcr.io/brettinternet/cgit:latest
    environment:
      <<: *environment
      ROOT_TITLE: "git.${PUBLIC_DOMAIN}"
      ROOT_DESC: Mirrors of various public projects
      ROOT_README: /srv/git/README.md
      SECTION_FROM_STARTPATH: 1
      NOPLAINEMAIL: 1
    volumes:
      - "${CONFIG_DIR}/git:/srv/git"
    labels:
      traefik.enable: "true"
      traefik.http.routers.cgit-public.middlewares: hsts-header
      traefik.http.routers.cgit-public.rule: Host(`git.${PUBLIC_DOMAIN}`)
      traefik.http.routers.cgit-public.entrypoints: websecure
      traefik.http.services.cgit-public.loadbalancer.server.port: 80

  mirrors_public:
    <<: *service
    image: ghcr.io/brettinternet/update-mirrors:latest
    environment:
      <<: *environment
      PRE_COMMANDS: |-
        curl -fsS -m 10 --retry 5 -o /dev/null "http://healthchecks:8000/ping/${HEALTHCHECKS_MIRRORS_PUBLIC_REMOTE_BACKUP_UUID}/start"
      POST_COMMANDS_FAILURE: |-
        curl -fsS -m 10 --retry 5 -o /dev/null "http://healthchecks:8000/ping/${HEALTHCHECKS_MIRRORS_PUBLIC_REMOTE_BACKUP_UUID}/fail"
      POST_COMMANDS_SUCCESS: |-
        curl -fsS -m 10 --retry 5 -o /dev/null "http://healthchecks:8000/ping/${HEALTHCHECKS_MIRRORS_PUBLIC_REMOTE_BACKUP_UUID}"
      CRON: "*/20 * * * *"
      WORKING_DIRECTORY: /repos
      GIT_REMOTE_1: https://github.com/brettinternet/homelab
      GIT_REMOTE_2: https://github.com/brettinternet/dotfiles
      GIT_REMOTE_3: https://github.com/brettinternet/linux
      GIT_REMOTE_4: https://github.com/brettinternet/windows
      GIT_REMOTE_5: https://github.com/brettinternet/keyboards
      GIT_REMOTE_6: https://github.com/brettinternet/slides
      GIT_REMOTE_7: https://github.com/brettinternet/algorithms
      GIT_REMOTE_8: https://github.com/brettinternet/mic-mute
      GIT_REMOTE_9: https://github.com/brettinternet/provision
      GIT_REMOTE_10: https://github.com/brettinternet/brettinternet.github.io
      GIT_REMOTE_11: https://github.com/brettinternet/containers
      GIT_REMOTE_12: https://github.com/brettinternet/archive
    volumes:
      - "${CONFIG_DIR}/git:/repos"

  # cgit_private:
  #   <<: *service
  #   image: ghcr.io/brettinternet/cgit:latest
  #   environment:
  #     <<: *environment
  #     ROOT_TITLE: "git.${PRIVATE_DOMAIN}"
  #     ROOT_DESC: Private mirrors
  #     ROOT_README: /srv/git/README.md
  #     SECTION_FROM_STARTPATH: 1
  #     NOPLAINEMAIL: 1
  #   volumes:
  #     - "${CONFIG_DIR}/git_priv:/srv/git"
  #   labels:
  #     traefik.enable: "true"
  #     traefik.http.routers.cgit-private.middlewares: hsts-header, ipallowlist, authelia_private
  #     traefik.http.routers.cgit-private.rule: Host(`git.${PRIVATE_DOMAIN}`)
  #     traefik.http.routers.cgit-private.entrypoints: websecure
  #     traefik.http.services.cgit-private.loadbalancer.server.port: 80

  mirrors_private:
    <<: *service
    image: ghcr.io/brettinternet/update-mirrors:latest
    environment:
      <<: *environment
      PRE_COMMANDS: |-
        curl -fsS -m 10 --retry 5 -o /dev/null "http://healthchecks:8000/ping/${HEALTHCHECKS_MIRRORS_PRIVATE_REMOTE_BACKUP_UUID}/start"
      POST_COMMANDS_FAILURE: |-
        curl -fsS -m 10 --retry 5 -o /dev/null "http://healthchecks:8000/ping/${HEALTHCHECKS_MIRRORS_PRIVATE_REMOTE_BACKUP_UUID}/fail"
      POST_COMMANDS_SUCCESS: |-
        curl -fsS -m 10 --retry 5 -o /dev/null "http://healthchecks:8000/ping/${HEALTHCHECKS_MIRRORS_PRIVATE_REMOTE_BACKUP_UUID}"
      CRON: "0 */1 * * *"
      WORKING_DIRECTORY: /repos
      GIT_REMOTE_1: "${MIRRORS_GIT_REMOTE_1}"
      GIT_REMOTE_2: "${MIRRORS_GIT_REMOTE_2}"
      GIT_REMOTE_3: "${MIRRORS_GIT_REMOTE_3}"
      GIT_REMOTE_4: "${MIRRORS_GIT_REMOTE_4}"
      GIT_REMOTE_5: "${MIRRORS_GIT_REMOTE_5}"
      GIT_REMOTE_6: "${MIRRORS_GIT_REMOTE_6}"
      GIT_REMOTE_7: "${MIRRORS_GIT_REMOTE_7}"
      GIT_REMOTE_8: "${MIRRORS_GIT_REMOTE_8}"
      GIT_REMOTE_9: "${MIRRORS_GIT_REMOTE_9}"
      GIT_REMOTE_10: "${MIRRORS_GIT_REMOTE_10}"
      GIT_REMOTE_11: "${MIRRORS_GIT_REMOTE_11}"
      GIT_REMOTE_12: "${MIRRORS_GIT_REMOTE_12}"
      GIT_REMOTE_13: "${MIRRORS_GIT_REMOTE_13}"
      GIT_REMOTE_14: "${MIRRORS_GIT_REMOTE_14}"
    volumes:
      - "${CONFIG_DIR}/git_priv:/repos"
