---
x-options: &options
  profiles: [media]
  networks: [default]
  environment: &environment
    TZ: "${TIMEZONE}"
  deploy:
    restart_policy:
      condition: on-failure
      delay: 5s
      max_attempts: 3
      window: 45s

services:
  plex:
    <<: *options
    image: linuxserver/plex:latest
    environment:
      <<: *environment
      PUID: "${PUID}"
      PGID: "${PGID}"
      VERSION: docker
    devices:
      - /dev/dri:/dev/dri
      - /dev/dvb:/dev/dvb
    ports:
      # - 127.0.0.1:32400:32400/tcp
      - "32400:32400/tcp"
      # Plex DLNA Server
      # https://support.plex.tv/articles/200350536-dlna/
      - 32469:32469/tcp
      - 1900:1900/udp
      # GDM Network discovery
      # https://support.plex.tv/articles/200430283-network/
      - 32410:32410/udp
      - 32412:32412/udp
      - 32413:32413/udp
      - 32414:32414/udp
    volumes:
      - "${CONFIG_DIR}/plex:/config"
      - "${MEDIA_DIR}/library:/data/library"
    tmpfs:
      - /transcode
    labels:
      traefik.enable: "true"
      traefik.http.routers.plex.rule: Host(`plex.${PUBLIC_DOMAIN}`)
      traefik.http.services.plex.loadbalancer.server.port: 32400

  # plex-alt:
  #   <<: *options
  #   image: plexinc/pms-docker:plexpass
  #   environment:
  #     <<: *environment
  #     PLEX_UID: "${PUID}"
  #     PLEX_GID: "${PGID}"
  #     # Remote access will look at `ADVERTISE_IP`, but because it's behind a proxy, it's likely that
  #     # the dashboard will say "Not available outside your network" even though it is... >:(
  #     # The local IP is also required for direct play with some apps (such as the Apple TV apparently)
  #     ADVERTISE_IP: "https://plex.${PUBLIC_DOMAIN},http://${LB_PLEX_ADDR}:32400"
  #     ALLOWED_NETWORKS: "10.1.1.0/24,10.1.2.0/24,10.42.0.0/16,10.43.0.0/16"
  #   devices:
  #     - /dev/dri:/dev/dri
  #     - /dev/serial/by-id/${DEVICE_ID_ZWAVE}:/dev/ttyUSB0
  #   ports:
  #     # - 127.0.0.1:32400:32400/tcp
  #     - "32400:32400/tcp"
  #     # Plex DLNA Server
  #     # https://support.plex.tv/articles/200350536-dlna/
  #     - 32469:32469/tcp
  #     - 1900:1900/udp
  #     # GDM Network discovery
  #     # https://support.plex.tv/articles/200430283-network/
  #     - 32410:32410/udp
  #     - 32412:32412/udp
  #     - 32413:32413/udp
  #     - 32414:32414/udp
  #   volumes:
  #     - "${CONFIG_DIR}/plex:/config"
  #     - "${MEDIA_DIR}/library:/data/library"
  #   tmpfs:
  #     - "/tmp"
  #   labels:
  #     traefik.enable: "true"
  #     traefik.http.routers.plex.rule: Host(`plex.${PUBLIC_DOMAIN}`)
  #     traefik.http.services.plex.loadbalancer.server.port: 32400
