---
x-options: &options
  profiles: [home]
  environment: &environment
    TZ: "${TIMEZONE}"
  deploy:
    restart_policy:
      condition: unless-stopped

services:
  homeassistant:
    <<: *options
    image: ghcr.io/home-assistant/home-assistant:stable
    network_mode: host
    cap_add:
      - CAP_NET_RAW
      - CAP_NET_BIND_SERVICE
    environment:
      <<: *environment
      PUID: "${PUID}"
      PGID: "${PGID}"
    volumes:
      - "${CONFIG_DIR}/homeassistant:/config"
    devices:
      - /dev/serial/by-id/${DEVICE_ID_ZWAVE}:/dev/ttyUSB0
      - /dev/serial/by-id/${DEVICE_ID_ZIGBEE}:/dev/ttyUSB1
    labels:
      traefik.enable: "true"
      traefik.http.routers.homeassistant.rule: Host(`home.${PUBLIC_DOMAIN}`)
      traefik.http.services.homeassistant.loadbalancer.server.port: 8123
      traefik.http.routers.homeassistant.entrypoints: websecure

  esphome:
    <<: *options
    image: esphome/esphome:latest
    networks: [default]
    environment:
      <<: *environment
      ESPHOME_DASHBOARD_USE_PING: "true"
    volumes:
      - "${CONFIG_DIR}/esphome:/config"
    labels:
      traefik.enable: "true"
      traefik.http.routers.esphome.middlewares: hsts-header, ipallowlist, authelia_private
      traefik.http.routers.esphome.rule: Host(`esphome.${PRIVATE_DOMAIN}`)
      traefik.http.services.esphome.loadbalancer.server.port: 6052
      traefik.http.routers.esphome.entrypoints: websecure

  frigate:
    <<: *options
    image: ghcr.io/blakeblackshear/frigate:stable
    networks: [default]
    environment:
      <<: *environment
      FRIGATE_RTSP_PASSWORD: "${FRIGATE_RTSP_PASSWORD}"
      FRIGATE_MQTT_PASSWORD: "${FRIGATE_MQTT_PASSWORD}"
    volumes:
      - "${CONFIG_DIR}/frigate/config.yml:/config/config.yml"
      - cameras:/media/frigate
      - type: tmpfs
        target: /tmp/cache
        tmpfs:
          size: 4000000000
    shm_size: 1gb
    ports:
      - 127.0.0.1:5000:5000
    labels:
      traefik.enable: "true"
      traefik.http.routers.frigate.middlewares: hsts-header, ipallowlist, authelia_private
      traefik.http.routers.frigate.rule: Host(`video.${PRIVATE_DOMAIN}`)
      traefik.http.services.frigate.loadbalancer.server.port: 5000
      traefik.http.routers.frigate.entrypoints: websecure

  mosquitto:
    <<: *options
    networks: [default]
    image: eclipse-mosquitto:latest
    ports:
      - 1883:1883
      - 9001:9001
    volumes:
      - "${CONFIG_DIR}/mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf"
      - "${CONFIG_DIR}/mosquitto/data:/mosquitto/data"
      - "${CONFIG_DIR}/mosquitto/log:/mosquitto/log"
