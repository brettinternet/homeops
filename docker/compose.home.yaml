---
version: "3.7"

x-options: &options
  profiles:
    - &profile home
  environment: &environment
    TZ: "${TIMEZONE}"
  restart: unless-stopped
  networks:
    - default

services:
  homeassistant:
    <<: *options
    image: ghcr.io/home-assistant/home-assistant:stable
    container_name: homeassistant
    cap_add:
      - CAP_NET_RAW
      - CAP_NET_BIND_SERVICE
    environment:
      <<: *environment
      PUID: "${PUID}"
      PGID: "${PGID}"
    volumes:
      - "${CONFIG_DIR}/homeassistant:/config"
    devices:
      - /dev/serial/by-id/${DEVICE_ID_ZWAVE}:/dev/ttyUSB0
      - /dev/serial/by-id/${DEVICE_ID_ZIGBEE}:/dev/ttyUSB1
    ports:
      - 8123:8123/tcp
    labels:
      traefik.enable: "true"
      traefik.http.routers.homeassistant.tls.certresolver: public
      traefik.http.routers.homeassistant.rule: Host(`home.${PUBLIC_DOMAIN}`)
      traefik.http.services.homeassistant.loadbalancer.server.port: 8123

  esphome:
    <<: *options
    image: esphome/esphome:latest
    container_name: esphome
    environment:
      <<: *environment
      ESPHOME_DASHBOARD_USE_PING: true
    volumes:
      - "${CONFIG_DIR}/esphome:/config"
    labels:
      traefik.enable: "true"
      traefik.http.routers.esphome.tls.certresolver: private
      traefik.http.routers.esphome.rule: Host(`esphome.${PRIVATE_DOMAIN}`)
      traefik.http.services.esphome.loadbalancer.server.port: 6052

  frigate:
    <<: *options
    image: ghcr.io/blakeblackshear/frigate:stable
    container_name: frigate
    environment:
      <<: *environment
      FRIGATE_RTSP_PASSWORD: "${FRIGATE_RTSP_PASSWORD}"
      FRIGATE_MQTT_PASSWORD: "${FRIGATE_MQTT_PASSWORD}"
    volumes:
      - "${CONFIG_DIR}/frigate/config.yml:/config/config.yml"
      - "${CONFIG_DIR}/frigate/data:/media/frigate"
      - type: tmpfs
        target: /tmp/cache
        tmpfs:
          size: 4gb
    shm_size: 1gb
    # 1935
    labels:
      traefik.enable: "true"
      traefik.http.routers.frigate.tls.certresolver: private
      traefik.http.routers.frigate.rule: Host(`video.${PRIVATE_DOMAIN}`)
      traefik.http.services.frigate.loadbalancer.server.port: 5000

  mosquitto:
    <<: *options
    image: eclipse-mosquitto:latest
    container_name: mosquitto
    volumes:
      - "${CONFIG_DIR}/mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf"
      - "${CONFIG_DIR}/mosquitto/data:/mosquitto/data"
      - "${CONFIG_DIR}/mosquitto/log:/mosquitto/log"
