---
x-options: &options
  networks: [default]
  environment: &environment
    TZ: "${TIMEZONE}"
  deploy:
    restart_policy:
      condition: on-failure
      delay: 5s
      max_attempts: 3
      window: 45s

services:
  echo:
    <<: *options
    image: jmalloc/echo-server:latest
    environment:
      <<: *environment
      PORT: 80
    labels:
      traefik.enable: "true"
      traefik.http.routers.echo.rule: Host(`echo.${PUBLIC_DOMAIN}`)
      traefik.http.services.echo.loadbalancer.server.port: 80
      traefik.http.routers.echo.entrypoints: websecure

  echo-priv:
    <<: *options
    image: jmalloc/echo-server:latest
    environment:
      <<: *environment
      PORT: 80
    labels:
      traefik.enable: "true"
      traefik.http.routers.echo-priv.middlewares: ipallowlist
      traefik.http.routers.echo-priv.rule: Host(`echo.${PRIVATE_DOMAIN}`)
      traefik.http.services.echo-priv.loadbalancer.server.port: 80
      traefik.http.routers.echo-priv.entrypoints: websecure

  busybox:
    <<: *options
    image: library/busybox:latest
    command:
      - sleep
      - "3600"

  visualizer:
    <<: *options
    image: dockersamples/visualizer
    environment:
      <<: *environment
      DOCKER_HOST: tcp://socket-proxy:2375
    labels:
      traefik.enable: "true"
      traefik.http.routers.visualizer.middlewares: hsts-header, ipallowlist
      traefik.http.routers.visualizer.rule: Host(`swarm.${PRIVATE_DOMAIN}`)
      traefik.http.services.visualizer.loadbalancer.server.port: 8080
      traefik.http.routers.visualizer.entrypoints: websecure
