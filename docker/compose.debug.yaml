---
x-options: &options
  profiles: [debug]
  networks: [default]
  environment: &environment
    TZ: "${TIMEZONE}"
  deploy:
    restart_policy:
      condition: on-failure
      delay: 5s
      max_attempts: 3
      window: 45s

services:
  echo_public:
    <<: *options
    image: jmalloc/echo-server:latest
    environment:
      <<: *environment
      PORT: 80
    labels:
      traefik.enable: "true"
      traefik.http.routers.echo-public.middlewares: hsts-header, authelia_public
      traefik.http.routers.echo-public.rule: Host(`echo.${PUBLIC_DOMAIN}`)
      traefik.http.services.echo-public.loadbalancer.server.port: 80
      traefik.http.routers.echo-public.entrypoints: websecure

  echo_private:
    <<: *options
    image: jmalloc/echo-server:latest
    environment:
      <<: *environment
      PORT: 80
    labels:
      traefik.enable: "true"
      traefik.http.routers.echo-private.middlewares: hsts-header, ipallowlist, authelia_private
      traefik.http.routers.echo-private.rule: Host(`echo.${PRIVATE_DOMAIN}`)
      traefik.http.services.echo-private.loadbalancer.server.port: 80
      traefik.http.routers.echo-private.entrypoints: websecure

  busybox:
    # <<: *options # disabled
    image: library/busybox:latest
    command:
      - sleep
      - "3600"
