---
version: "3"

vars:
  PROJECT: homelab
  SECRETS_FILE: sops.env
  COMPOSE_FILES:
    sh: find . -type f -iname "compose*.yaml" -exec basename {} ';' | sort -r
  COMPOSE_FILES_ARGS: -f {{ .COMPOSE_FILES | splitLines | join " -f " }}
  DOCKER_COMMAND: docker -p {{ .PROJECT }} {{ .COMPOSE_FILES_ARGS }}
  COMPOSE_COMMAND: docker-compose --parallel 5 -p {{ .PROJECT }} {{ .COMPOSE_FILES_ARGS }}

env:
  COMPOSE_PROJECT: \{{ .PROJECT }}
  COMPOSE_PROFILES: base,utils,home,backup,monitoring,sites,auth,networking,media
  COMPOSE_HTTP_TIMEOUT: 300
  # See Docker's SSH tips: https://docs.docker.com/engine/security/protect-access/#ssh-tips
  DOCKER_HOST: ssh://gertrude

tasks:
  default:
    silent: true
    cmds:
      - task -l

  configs:
    desc: List compose configuration files
    silent: true
    cmds:
      - "echo 'Compose files:\n\n{{ .COMPOSE_FILES }}'"

  d:
    desc: Run docker command with secrets in the environment
    cmds:
      - sops exec-env {{ .SECRETS_FILE }} '{{ .DOCKER_COMMAND }} {{ .CLI_ARGS }}'
    requires:
      vars: [SECRETS_FILE]

  dc:
    desc: Run docker-compose command with secrets in the environment
    cmds:
      - sops exec-env {{ .SECRETS_FILE }} '{{ .COMPOSE_COMMAND }} {{ .CLI_ARGS }}'
    requires:
      vars: [SECRETS_FILE]

  pull:
    desc: Pull images on docker host
    cmds:
      - sops exec-env {{ .SECRETS_FILE }} '{{ .COMPOSE_COMMAND }} pull'
    requires:
      vars: [SECRETS_FILE]

  up:
    desc: Deploy compose files; This targets a single node 'DOCKER_HOST' or locahost.
    cmds:
      # - task: up-nfs
      - sops exec-env {{ .SECRETS_FILE }} '{{ .COMPOSE_COMMAND }} up -d --remove-orphans'
    requires:
      vars: [SECRETS_FILE]

  stop:
    desc: Stop compose containers on host
    cmds:
      - sops exec-env {{ .SECRETS_FILE }} '{{ .COMPOSE_COMMAND }} down --remove-orphans'
    requires:
      vars: [SECRETS_FILE]

  down:
    desc: Stop and clean up containers on host
    cmds:
      - sops exec-env {{ .SECRETS_FILE }} '{{ .COMPOSE_COMMAND }} down --remove-orphans --rmi all'
    requires:
      vars: [SECRETS_FILE]

  verify:
    desc: Stop and clean up containers on host
    cmds:
      - sops exec-env {{ .SECRETS_FILE }} '{{ .COMPOSE_COMMAND }} config'
    requires:
      vars: [SECRETS_FILE]

  up-nfs:
    desc: Deploy compose files; This targets a media NFS.
    env:
      DOCKER_HOST: ssh://bogota
      COMPOSE_PROFILES: media-nfs
    cmds:
      - sops exec-env {{ .SECRETS_FILE }} '{{ .COMPOSE_COMMAND }} up -d --remove-orphans'
    requires:
      vars: [SECRETS_FILE]
