---
version: "3"

vars:
  PROJECT: homelab
  SECRETS_FILE: sops.env
  SOPS_COMMAND: sops exec-env {{ .SECRETS_FILE }}
  COMPOSE_FILES:
    sh: find . -type f -iname "compose*.yaml" -exec basename {} ';' | sort -r
  COMPOSE_FILES_ARGS: -f {{ .COMPOSE_FILES | splitLines | join " -f " }}
  DOCKER_COMMAND: docker -p {{ .PROJECT }} {{ .COMPOSE_FILES_ARGS }}
  COMPOSE_COMMAND: docker-compose --parallel 5 -p {{ .PROJECT }} {{ .COMPOSE_FILES_ARGS }}
  SERVICES_COMPOSE_FILES: base,utils,home,backup,monitoring,sites,auth,networking,media,dev

env:
  COMPOSE_PROJECT: "{{ .PROJECT }}"
  COMPOSE_HTTP_TIMEOUT: 300

tasks:
  default:
    silent: true
    cmds:
      - task -l

  configs:
    desc: List compose configuration files
    silent: true
    cmds:
      - "echo 'Compose files:\n\n{{ .COMPOSE_FILES }}'"

  d:
    desc: Run docker command with secrets in the environment
    cmds:
      - "{{ .SOPS_COMMAND }} '{{ .DOCKER_COMMAND }} {{ .CLI_ARGS }}'"
    requires:
      vars: [SECRETS_FILE]

  dc:
    desc: Run docker-compose command with secrets in the environment
    cmds:
      - "{{ .SOPS_COMMAND }} '{{ .COMPOSE_COMMAND }} {{ .CLI_ARGS }}'"
    requires:
      vars: [SECRETS_FILE]

  pull:
    desc: Pull images on docker host
    env:
      COMPOSE_PROFILES: "{{ .SERVICES_COMPOSE_FILES }}"
      DOCKER_HOST: ssh://gertrude
    cmds:
      - "{{ .SOPS_COMMAND }} '{{ .COMPOSE_COMMAND }} pull'"
    requires:
      vars: [SECRETS_FILE]

  up:
    desc: Deploy compose files to hosts
    cmds:
      - task: nfs-up
      - task: services-up

  nfs-up:
    env:
      COMPOSE_PROFILES: nfs
      DOCKER_HOST: ssh://bogota
    cmds:
      - "{{ .SOPS_COMMAND }} '{{ .COMPOSE_COMMAND }} up -d --remove-orphans'"

  services-up:
    env:
      COMPOSE_PROFILES: "{{ .SERVICES_COMPOSE_FILES }}"
      # See Docker's SSH tips: https://docs.docker.com/engine/security/protect-access/#ssh-tips
      DOCKER_HOST: ssh://gertrude
    cmds:
      - echo $COMPOSE_PROFILES
      - "{{ .SOPS_COMMAND }} '{{ .COMPOSE_COMMAND }} up -d --remove-orphans'"

  compose-up:
    cmds:
      - "{{ .SOPS_COMMAND }} '{{ .COMPOSE_COMMAND }} up -d --remove-orphans'"
    requires:
      vars: [SECRETS_FILE]

  stop:
    desc: Stop compose containers on host
    env:
      COMPOSE_PROFILES: "{{ .SERVICES_COMPOSE_FILES }}"
      DOCKER_HOST: ssh://gertrude
    cmds:
      - "{{ .SOPS_COMMAND }} '{{ .COMPOSE_COMMAND }} down --remove-orphans'"
    requires:
      vars: [SECRETS_FILE]

  down:
    desc: Stop and clean up containers on host
    env:
      COMPOSE_PROFILES: "{{ .SERVICES_COMPOSE_FILES }}"
      DOCKER_HOST: ssh://gertrude
    cmds:
      - "{{ .SOPS_COMMAND }} '{{ .COMPOSE_COMMAND }} down --remove-orphans --rmi all'"
    requires:
      vars: [SECRETS_FILE]

  verify:
    desc: Stop and clean up containers on host
    cmds:
      - "{{ .SOPS_COMMAND }} '{{ .COMPOSE_COMMAND }} config'"
    requires:
      vars: [SECRETS_FILE]
