---
- name: Setup homelab servers
  hosts:
    - media
    - server
  tags: setup
  pre_tasks:
    ### Official ###
    - name: Install packages (pacman)
      become: true
      tags: update
      ansible.builtin.package:
        name:
          # Setup
          - base
          - dhcpcd
          - dosfstools
          - efibootmgr
          - git
          - grub
          - vim
          - linux
          - linux-headers
          - linux-firmware
          - mtools
          - nano
          - os-prober
          # Base
          - broot
          - clamav
          - curl
          - etckeeper
          - fd
          - firejail
          - fzy
          - htop
          - hwinfo
          - intel-ucode
          - man-db
          - mesa
          - ncdu
          - neofetch
          - networkmanager
          - net-tools
          - openssh
          - powertop
          - reflector
          - rsync
          - smartmontools
          - speedtest-cli
          - the_silver_searcher
          - tmux
          - trash-cli
          - ttf-liberation
          - unzip
          - usbguard
          - usbutils
          - vifm
          - zsh
          - wget
          - w3m
          # Server
          - cockpit
          - cockpit-machines
          - cockpit-pcp
          - cockpit-podman
          - cronie
          - crun # https://github.com/containers/podman/issues/8687
          - inetutils
          - packagekit
          - podman
          - renameutils
          - udisks2
  roles:
    ### AUR ###
    # - role: yay
    #   tags: update
    #   vars:
    #     yay_packages:
    #       # Base
    #       - downgrade
    #       - python-fangfrisch
    #       - vim-plug
    #       - needrestart
    #     yay_state: present
    # If upgrades fail, it's likely the server requires manual intervention to
    # upgrade `linux` kernel with `zfs-linux`
    # - upgrade
    - sudoers
    - ssh_setup
    # - prometheus
    - cockpit
    - clamav

# BEFORE: some manual setup with mergerfs and fstab mounts is required
- name: Setup media server
  hosts: media
  tags: setup
  pre_tasks:
    ### Official ###
    - name: Install packages (pacman)
      become: true
      tags: update
      ansible.builtin.package:
        name:
          - transmission-cli
        state: present
  roles:
    ### AUR ###
    # - role: yay
    #   tags: update
    #   vars:
    #     yay_packages:
    #       - mergerfs
    #       - snapraid
    #     yay_state: present
    #     yay_extra_args:
    - role: snapraid
      vars:
        # TODO: add email values for snapraid-runner.conf.j2
        parity_disks:
          - path: /mnt/parity1
            content: false
          - path: /mnt/parity2
            content: false
        data_disks:
          - path: /mnt/disk1
            content: true
          - path: /mnt/disk2
            content: true
          - path: /mnt/disk3
            content: false
          - path: /mnt/disk4
            content: false
          - path: /mnt/disk5
            content: false
        snapraid_config_includes:
          - /appdata/calibre-shared/Calibre\ Library/
        snapraid_config_excludes:
          - "*.unrecoverable"
          - /tmp/
          - /lost+found/
          - /downloads/
          - /appdata/
          - snapshots/
          - "*.!sync"
          - .AppleDouble
          - ._AppleDouble
          - .DS_Store
          - ._.DS_Store
          - .Thumbs.db
          - .fseventsd
          - .Spotlight-V100
          - .TemporaryItems
          - .Trashes
          - .Trash-*
          - .AppleDB

- name: Setup general server
  hosts: server
  tags: setup
  pre_tasks:
    ### Official ###
    - name: Install packages (pacman)
      become: true
      tags: update
      ansible.builtin.package:
        name:
          - libvirt # Also includes qemu-headless
        state: present

    # Ignore zfs-dkms and zfs-utils AUR packages and upgrade them explicitly
    - name: Ignore ZFS packages
      become: true
      tags: update
      ansible.builtin.lineinfile:
        path: /etc/pacman.conf
        line: "IgnorePkg = zfs-dkms zfs-utils"
        insertafter: IgnorePkg
        state: present

  roles:
    ### AUR ###
    # - role: yay
    #   tags: update
    #   vars:
    #     yay_packages:
    #       - cockpit-zfs-manager
    #     yay_state: present
    #     yay_extra_args:
    # Explicitly upgrade packages that are in IgnorePkg list
    # - role: yay
    #   tags: update
    #   vars:
    #     yay_packages:
    #       - zfs-dkms
    #       - zfs-utils
    #     yay_state: latest
    #     yay_extra_args: --batchinstall --answerclean All --nodeps
    #   when: upgrade_zfs
# TODO: Setup/manage or just check state of ZFS https://wiki.archlinux.org/index.php/ZFS
# https://docs.ansible.com/ansible/latest/collections/community/general/zfs_module.html
# https://wiki.archlinux.org/index.php/ZFS

# TODO: check smart output for disk errors
# https://wiki.archlinux.org/index.php/S.M.A.R.T.
# https://github.com/grimmjow8/ansible-smartmontools
# https://github.com/LibreIT/ansible-smartd
# https://github.com/stuvusIT/smartd

# TODO: add telegraf support, and others
# https://github.com/dj-wasabi/ansible-telegraf

# Additional setup:
# https://github.com/ironicbadger/infra
# https://github.com/davestephens/ansible-nas

# TODO: backup with rsync
# https://docs.ansible.com/ansible/latest/collections/ansible/posix/synchronize_module.html
# https://wiki.archlinux.org/title/Synchronization_and_backup_programs

# TODO: setup powertop auto tune service https://wiki.archlinux.org/index.php/Powertop
# TODO: fix prometheus rootless volume permissions https://github.com/MoOyeg/Rootless-Podman-For-Prometheus-Grafana/blob/main/prometheus.sh
# TODO: add alertmanager https://hub.docker.com/r/prom/alertmanager
# TODO: add grafana https://prometheus.io/docs/visualization/grafana/
# TODO: integrate traefik with prometheus https://prometheus.io/docs/instrumenting/exporters/
# TODO: setup samba share
