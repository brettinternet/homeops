---
- name: Server packages
  hosts: server
  roles:
    ### AUR ###
    - role: yay
      vars:
        packages:
          # Base
          - downgrade
          - powerpill
          - python-fangfrisch
          - tzupdate
          - vim-plug
          # Server
          - mergerfs
          - needrestart
          - snapraid
          - cockpit-zfs-manager
        state: present
    # Explicitly upgrade packages that are in IgnorePkg list
    - role: yay
      vars:
        packages:
          - zfs-dkms-git
          - zfs-utils-git
        state: latest
      when: upgrade_zfs
    # If upgrades fail, it's likely the server requires manual intervention to
    # upgrade `linux` kernel with `zfs-linux`
    - role: upgrade
      vars:
        allow_reboot: false
  pre_tasks:
    ### Official ###
    - name: Install packages (pacman)
      become: true
      ansible.builtin.package:
        name:
          # Setup
          - base
          - dhcpcd
          - dosfstools
          - efibootmgr
          - git
          - grub
          - gvim
          - linux
          - linux-headers
          - linux-firmware
          - mtools
          - nano
          - os-prober
          # Base
          - broot
          - clamav
          - curl
          - etckeeper
          - fd
          - firejail
          - fzy
          - htop
          - hwinfo
          - intel-ucode
          - man-db
          - mesa
          - neofetch
          - networkmanager
          - openssh
          - pacmatic
          - reflector
          - rsync
          - smartmontools
          - speedtest-cli
          - the_silver_searcher
          - tmux
          - trash-cli
          - ttf-liberation
          - unzip
          - usbguard
          - usbutils
          - vifm
          - zsh
          - wget
          - w3m
          # Server
          - cockpit
          - cockpit-machines
          - cockpit-pcp
          - cockpit-podman
          - udisks2
          - packagekit
          - cronie
          - libvirt # Also includes qemu-headless
          # - docker
          # - docker-compose
          - podman
          - crun # https://github.com/containers/podman/issues/8687
          - terraform
          - transmission-cli
        state: present

    # Ignore zfs-dkms and zfs-utils AUR packages and upgrade them explicitly
    - name: Add private environment values
      become: true
      ansible.builtin.lineinfile:
        path: /etc/pacman.conf
        line: "IgnorePkg = zfs-dkms-git zfs-utils-git"
        state: present
