---
- name: Server packages
  hosts: server
  roles:
    # If upgrades fail, it's likely the server requires manual intervention to
    # upgrade `linux` kernel with `zfs-linux`
    - role: upgrade
      vars:
        allow_reboot: no
  pre_tasks:
    ### Official ###
    - name: Install packages (pacman)
      become: yes
      pacman:
        name:
          # Setup
          - base
          - dhcpcd
          - dosfstools
          - efibootmgr
          - git
          - grub
          - gvim
          - linux
          - linux-firmware
          - mtools
          - nano
          - os-prober
          # Base
          - broot
          - clamav
          - curl
          - etckeeper
          - fd
          - firejail
          - fzy
          - htop
          - hwinfo
          - intel-ucode
          - man-db
          - mesa
          - neofetch
          - networkmanager
          - openssh
          - pacmatic
          - reflector
          - rsync
          - smartmontools
          - speedtest-cli
          - the_silver_searcher
          - tmux
          - trash-cli
          - ttf-liberation
          - unzip
          - usbguard
          - usbutils
          - vifm
          - zsh
          - wget
          - w3m
          # Server
          - cockpit
          - cockpit-machines
          - cockpit-pcp
          - cockpit-podman
          - udisks2
          - packagekit
          - cronie
          - libvirt # Also includes qemu-headless
          # - docker
          # - docker-compose
          - podman
          - crun # https://github.com/containers/podman/issues/8687
          - terraform
          - transmission-cli
        state: present

    ### AUR ###
    - block:
        - name: Create aur_builder
          become: yes
          user:
            name: aur_builder
            create_home: no
            group: sudo

        - name: Add aur_builder to sudoers
          become: yes
          lineinfile:
            path: /etc/sudoers.d/11-install-aur_builder
            line: "aur_builder ALL=(ALL) NOPASSWD: /usr/bin/pacman"
            create: yes
            validate: "visudo -cf %s"

        - name: Install AUR packages (yay)
          aur:
            use: yay
            aur_only: yes
            name:
              # Base
              - downgrade
              - powerpill
              - python-fangfrisch
              - tzupdate
              - vim-plug
              # Server
              - mergerfs
              - needrestart
              - snapraid
              - cockpit-zfs-manager
            state: present

    ### Unofficial repositories ###

    # Add archzfs repositories: https://wiki.archlinux.org/index.php/Unofficial_user_repositories#archzfs
    # Then, you may need downgrade the kernel to this package's version
    - name: Install zfs (pacman)
      become: yes
      pacman:
        name: zfs-linux
        state: present
