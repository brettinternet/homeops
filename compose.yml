---
- name: Setup media services
  hosts: media
  tags: services
  vars:
    containers:
      - adguard # redundant, secondary DNS
      - plex
      - nzbget
      - sonarr
      - radarr
      - readarr
      - calibre
      - calibre-web
    remove_containers:
      - tautulli
      - ombi
      - lazylibrarian
  roles:
    - role: compose
    # TODO: only forward once adguard is completely deployed!
    - role: ingress

- name: Setup general services
  hosts: server
  tags: services
  vars:
    # Containers to use (roles/compose/tasks)
    containers:
      - adguard
      - adguard-sync
      - mosquitto
      - babybuddy
      - uptime-kuma
      - home-assistant
      - espial
      - miniflux_db
      - miniflux
      - healthchecks
      - mealie
      - mealie_api
      - change-detection
      - minecraft
      - minecraft-bedrock
      - oauth
      - traefik
      - crowdsec
      - crowdsec-traefik-bouncer
      - crowdsec-dashboard
      - crowdsec-cloudflare-bouncer
    remove_containers:
      - frigate
      - organizr
      - valheim
      - valheim2
      - gitea_db
      - gitea
      - n8n_db
      - n8n
      - firefly_db
      - firefly
      - epicgames
      - scrutiny_web
      - scrutiny_collector
      - syncthing
      - prometheus
      - grafana

    # Traefik middleware, scrutiny_collector
    ingress_local_ip: "{{ hostvars['server']['ansible_host'] }}"

    # Containers with a frontend to use with Traefik (roles/traefik/templates)
    frontend_containers:
      # media server
      - name: plex
        host: media
      - name: nzbget
        host: media
      - name: sonarr
        host: media
      - name: radarr
        host: media
      - name: readarr
        host: media
      - name: calibre
        host: media
      - name: calibre-web
        host: media
      # server
      - name: adguard
        host: server
      - name: frigate
        host: server
      - name: espial
        host: server
      - name: change-detection
        host: server
      - name: miniflux
        host: server
      - name: healthchecks
        host: server
      - name: uptime-kuma
        host: server
      - name: babybuddy
        host: server
      - name: home-assistant
        host: server
      - name: mealie
        host: server
      - name: crowdsec-dashboard
        host: server
      - name: oauth
        host: server
      - name: traefik
        host: server
  roles:
    - role: traefik
      tags: traefik
      when: "'traefik' in containers"
    - role: compose
    # Forward DNS ports to rootless DNS resolver
    - role: ingress
# TODO: remove frontend files
# - name: tautulli
#   host: media
# - name: ombi
#   host: media
# - name: gitea
#   host: server
# - name: n8n
#   host: server
# - name: firefly
#   host: server
# - name: syncthing
#   host: server
# - name: prometheus
#   host: server
# - name: grafana
#   host: server
