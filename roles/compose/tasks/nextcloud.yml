---
- name: Wait for Nextcloud database
  containers.podman.podman_container_info:
    name: nextcloud_db
  register: nextcloud_db_info_result
  until: nextcloud_db_info_result.containers[0]['State']['Running']
  retries: 5
  delay: 3
  when: container_state in ['present', 'started']

- name: Wait for Nextcloud redis
  containers.podman.podman_container_info:
    name: nextcloud_redis
  register: nextcloud_redis_info_result
  until: nextcloud_redis_info_result.containers[0]['State']['Running']
  retries: 5
  delay: 3
  when: container_state in ['present', 'started']

# https://github.com/nextcloud/docker

- name: Nextcloud
  containers.podman.podman_container:
    name: nextcloud
    # https://hub.docker.com/_/nextcloud
    image: docker.io/library/nextcloud
    state: "{{ container_state }}"
    generate_systemd: "{{ container_generate_systemd }}"
    env:
      TZ: "{{ tz }}"
      POSTGRES_DB: nextcloud
      POSTGRES_USER: nextcloud
      POSTGRES_PASSWORD: "{{ nextcloud_postgres_password }}"
      POSTGRES_HOST: "{{ ansible_default_ipv4.address }}:5436"
      NEXTCLOUD_ADMIN_USER: admin
      NEXTCLOUD_ADMIN_PASSWORD: "{{ nextcloud_admin_password }}"
      NEXTCLOUD_TRUSTED_DOMAINS: "cloud.{{ root_domain }}"
    volumes:
      - "{{ appdata_dir }}/nextcloud:/var/www/html"
    ports:
      - 8081:80
    label:
      io.containers.autoupdate: registry
