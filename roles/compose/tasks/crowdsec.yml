---
- name: Wait for Traefik container
  containers.podman.podman_container_info:
    name: traefik
  register: traefik_info_result
  until: traefik_info_result.containers[0]['State']['Running']
  retries: 5
  delay: 3
  when: container_state in ['present', 'started']

# https://github.com/crowdsecurity/crowdsec
# TODO: use debian image and setup journalctl logs
# https://hub.docker.com/r/crowdsecurity/crowdsec
# Register a new bouncer:
# podman exec -it crowdsec cscli bouncers add <agent_user_name>
# or list machines: podman exec -it crowdsec cscli machines list

- name: crowdsec
  containers.podman.podman_container:
    name: crowdsec
    # https://hub.docker.com/r/crowdsecurity/crowdsec
    image: docker.io/crowdsecurity/crowdsec
    state: "{{ container_state }}"
    recreate: "{{ container_recreate }}"
    generate_systemd: "{{ container_generate_systemd }}"
    env:
      COLLECTIONS: "crowdsecurity/linux crowdsecurity/traefik"
      PID: "{{ puid }}"
      GID: "{{ pgid }}"
    volumes:
      # create acquis.yaml in config first: https://docs.crowdsec.net/docs/concepts/#acquisition
      - "{{ appdata_dir }}/crowdsec/data:/var/lib/crowdsec/data"
      - "{{ appdata_dir }}/crowdsec/config:/etc/crowdsec"
      - "{{ appdata_dir }}/traefik/logs:/var/log/traefik/:ro"
    ports:
      - 8088:8080
      # use for metrics such as prometheus:
      # - 6060:6060
    label:
      io.containers.autoupdate: image
