---
- name: Add user to dialout group
  become: true
  ansible.builtin.user:
    user: "{{ ansible_user }}"
    groups: dialout
    append: true

- name: home-assistant
  containers.podman.podman_container:
    name: home-assistant
    image: lscr.io/linuxserver/homeassistant
    state: "{{ container_state }}"
    recreate: "{{ container_recreate }}"
    generate_systemd: "{{ container_generate_systemd }}"
    env:
      PUID: "0"
      PGID: "0"
      TZ: "{{ tz }}"
    volumes:
      - "{{ appdata_dir }}/homeassistant:/config"
    # ports: # (network: host)
    #   - 8123:8123
    network: host
    cap_add:
      - CAP_NET_RAW
      - CAP_NET_BIND_SERVICE
    group_add: keep-groups
    # Ensure user has access to same group as devices
    device:
      # https://github.com/walthowd/husbzb-firmware
      - /dev/serial/by-id/usb-Silicon_Labs_HubZ_Smart_Home_Controller_71500236-if00-port0:/dev/ttyUSB0 # z-wave
      - /dev/serial/by-id/usb-Silicon_Labs_HubZ_Smart_Home_Controller_71500236-if01-port0:/dev/ttyUSB1 # zigbee
    label:
      io.containers.autoupdate: registry
