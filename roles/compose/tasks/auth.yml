# https://github.com/thomseddon/traefik-forward-auth

# BLOCKED BY: see issues in traefik.yml

- name: oauth
  containers.podman.podman_container:
    name: oauth
    # https://hub.docker.com/r/thomseddon/traefik-forward-auth
    image: docker.io/thomseddon/traefik-forward-auth
    state: "{{ state }}"
    restart: yes
    env:
      CLIENT_ID: "{{ oauth_client_id }}"
      CLIENT_SECRET: "{{ oauth_client_secret }}"
      SECRET: "{{ oauth_secret }}"
      INSECURE_COOKIE: false
      COOKIE_DOMAIN: "{{ root_domain }}"
      AUTH_HOST: "oauth.{{ root_domain }}"
      WHITELIST: "{{ oauth_whitelist }}"
      LOG_LEVEL: warn
      LOG_FORMAT: text
    ports:
      - 4181:4181
    labels:
      traefik.enable: true
      traefik.backend: oauth
      traefik.frontend.rule: "Host:oauth.{{ root_domain }}"
      traefik.port: 4181
      traefik.docker.network: traefik_proxy
      traefik.frontend.headers.SSLRedirect: true
      traefik.frontend.headers.STSSeconds: 315360000
      traefik.frontend.headers.browserXSSFilter: true
      traefik.frontend.headers.contentTypeNosniff: true
      traefik.frontend.headers.forceSTSHeader: true
      traefik.frontend.headers.STSIncludeSubdomains: true
      traefik.frontend.headers.STSPreload: true
      traefik.frontend.headers.customResponseHeaders: X-Robots-Tag:noindex,nofollow,nosnippet,noarchive,notranslate,noimageindex
      traefik.frontend.headers.frameDeny: true
      traefik.frontend.auth.forward.address: http://oauth:4181
      traefik.frontend.auth.forward.authResponseHeaders: X-Forwarded-User
      traefik.frontend.auth.forward.trustForwardHeader: true
