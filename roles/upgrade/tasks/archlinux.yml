---
- name: Update packages "-Syu" (pacman)
  community.general.pacman:
    update_cache: yes
    upgrade: yes

- name: Update AUR packages (yay)
  # ansible-galaxy install kewlfft.aur
  # https://github.com/kewlfft/ansible-aur
  include_role: kewlfft.aur
  tasks:
    - aur:
        use: yay
        upgrade: yes

- block:
    - name: Check if kernel needs update (Archlinux)
      # Source: https://bbs.archlinux.org/viewtopic.php?pid=1354255#p1354255
      # Need to modify to accommodate linux-lts and linux-hardened
      # Determines if installed kernel version is higher than runtime
      shell: '[[ $(pacman -Q linux | cut -d " " -f 2) > $(uname -r) ]]'
      args:
        executable: /bin/bash
      register: upgrade__should_restart_result
      failed_when: upgrade__should_restart_result.stderr != ""

    # See defaults: https://docs.ansible.com/ansible/latest/collections/ansible/builtin/reboot_module.html
    - name: Reboot
      reboot:
      when: upgrade__should_restart_result.rc == 0
  when: allow_reboot is true
