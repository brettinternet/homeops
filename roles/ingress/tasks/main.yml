---
# https://wiki.archlinux.org/title/Iptables

# Alternatively, you may allow podman unprivileged access to privileged ports
# https://github.com/containers/podman/issues/3212

- block:
    - name: Iptables flush filter
      become: true
      ansible.builtin.iptables:
        table: nat
        chain: PREROUTING
        flush: yes

    - name: Remove previous persistent iptable rules
      become: true
      ansible.builtin.file:
        path: /etc/iptables/rules.v4
        state: absent
  when: ingress__iptables_flush

- block:
    - name: Forward TCP DNS
      become: true
      iptables:
        table: nat
        chain: PREROUTING
        protocol: tcp
        destination_port: 53
        jump: DNAT
        to_destination: "{{ ansible_default_ipv4.address }}:4053"
        comment: Redirect DNS to unprivileged port served by Adguard's rootless container

    - name: Forward UDP DNS
      become: true
      iptables:
        table: nat
        chain: PREROUTING
        protocol: udp
        destination_port: 53
        jump: DNAT
        to_destination: "{{ ansible_default_ipv4.address }}:4053"
        comment: Redirect DNS to unprivileged port served by Adguard's rootless container

    - name: Persist iptable routing across reboots
      become: true
      shell: iptables-save > /etc/iptables/rules.v4
  when: ingress__enable_forwarding
