---
# With help from https://github.com/IronicBadger/ansible-role-snapraid
# TODO: send tail 10kb of logs to healthchecks
# TODO: use latest snapraid-runner instead of fork
# https://healthchecks.io/docs/attaching_logs/

- name: Check supported distribution
  fail:
    msg:
      - "Unsupported distribution: {{ ansible_facts['distribution'] | lower }}"
      - "Supported role distributions are {{ supported_distributions }}"
  when: ansible_facts['distribution'] | lower not in supported_distributions

- name: Install SnapRAID
  include_tasks: "install_{{ ansible_facts['distribution'] | lower }}.yml"

# https://www.snapraid.it/manual
- name: Create snapraid.conf
  become: true
  template:
    src: snapraid.conf.j2
    dest: "{{ snapraid_config }}"
    owner: root
    group: wheel
    mode: 0775

# snapraid-runner (snapraid automation)

# Using local copy for now, but may want to use upstream master soon
- name: Copy snapraid-runner.py
  become: true
  copy:
    src: "{{ role_path }}/files/snapraid-runner.py"
    dest: "{{ snapraid_runner_dir }}/"

# TODO: should clone latest instead of custom script with --quiet option?
# - block:
#     - name: Clone snapraid-runner
#       git:
#         repo: https://github.com/Chronial/snapraid-runner.git
#         dest: /tmp/snapraid-runner

#     - name: "Copy script to {{ snapraid_runner_dir }}"
#       copy:
#         remote_src: /tmp/snapraid-runner/snapraid-runner.py
#         dest: "{{ snapraid_runner_dir }}"

- name: Create snapraid-runner.conf
  become: true
  template:
    src: options.conf.j2
    dest: "{{ snapraid_runner_dir }}/options.conf"

# TODO: move to systemd timer/service instead of cron

- name: Create run.sh entrypoint
  become: true
  template:
    src: "run.sh.j2"
    dest: "{{ snapraid_runner_dir }}/run.sh"

# https://wiki.archlinux.org/index.php/Cron
- name: Setup snapraid-runner cron
  become: true
  cron:
    user: root
    name: snapraid_runner
    state: present
    job: "/bin/bash {{ snapraid_runner_dir }}/run.sh"
    minute: "00"
    hour: "03"
    day: "*"
    weekday: "*"
