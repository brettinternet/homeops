#!/bin/bash

if [ "$EUID" -ne 0 ]; then
  echo "Permission denied: SnapRAID requires root access."
  exit 126
fi

SERVICES_DIR="{{ docker_compose_dir }}"
cd $SERVICES_DIR

SERVICES_TO_SHUTDOWN=("automators" "espial" "mailserver" "miniflux" "nzbget" "watchtower")

run_as_user() {
    /bin/su -c "$@" - {{ ansible_user }}
}

run_as_user 'docker-compose down "${SERVICES_TO_SHUTDOWN[@]}"'

/usr/bin/python3 {{ snapraid_runner_dir }}/snapraid-runner.py -c {{ snapraid_runner_dir }}/snapraid-runner.conf -q
if [ $? -eq 0 ]; then
    echo "SUCCESS"
    # curl -fsS --retry 3 https://hc-ping.com/{snapraid_healthcheck_io_uuid} > /dev/null
else
    echo "ERROR: Unable to run snapraid-runner.py"
fi

run_as_user 'docker-compose up -d "${SERVICES_TO_SHUTDOWN[@]}"'
