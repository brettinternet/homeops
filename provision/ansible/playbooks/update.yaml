---
- hosts:
    - proxmox
  tasks:
    - name: upgrade
      ansible.builtin.apt:
        upgrade: true
        update_cache: true
        cache_valid_time: 86400 # one day

- hosts:
    - docker
  become: true
  vars:
    allow_reboot: false
    compose_dir: "{{ ansible_user['home'] }}/compose"
  pre_tasks:
    - name: Get docker service status
      ansible.builtin.systemd:
        name: docker.service
      register: docker_service_result

    - name: Stop docker compose
      ansible.builtin.command:
        cmd: docker-compose down
        chdir: "{{ compose_dir }}"
      failed_when: false
      changed_when: false
      when:
        - docker_service_result.status.ActiveState == 'active'

  roles:
    - role: upgrade
    - role: zfs
      when:
        - zpool is defined

  post_tasks:
    - name: Start docker compose
      ansible.builtin.command:
        cmd: docker-compose up -d --remove-orphans
        chdir: "{{ compose_dir }}"
      when:
        - docker_service_result.status.ActiveState == 'active'
