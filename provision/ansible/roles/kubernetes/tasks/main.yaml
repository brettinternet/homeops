---
- name: Check supported distribution
  ansible.builtin.fail:
    msg:
      - "Unsupported distribution: {{ ansible_facts['distribution'] | lower }}"
      - "Supported role distributions are {{ supported_distributions }}"
  when: ansible_facts['distribution'] | lower not in supported_distributions

- name: Get k3s service status
  ansible.builtin.systemd:
    name: k3s.service
  register: k3s_service_result

- name: Install dependencies
  ansible.builtin.include_tasks: "{{ ansible_facts['distribution'] | lower }}.yaml"
  vars:
    # Reboot only if initial setup
    allow_reboot: "{{ false if k3s_service_result.status.ActiveState == 'active' else true }}"

- name: Install k3s
  ansible.builtin.include_tasks: k3s.yaml
