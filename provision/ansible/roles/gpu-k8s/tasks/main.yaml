# https://wiki.archlinux.org/title/intel_graphics
---
- name: Install intel packages
  ansible.builtin.package:
    state: latest
    name:
      - mesa

### DEPRECATE nvidia ###
- name: Install nvidia packages
  ansible.builtin.package:
    state: absent
    name:
      - nvidia

- name: Install AUR nvidia container dependencies
  ansible.builtin.include_role:
    name: aur
  vars:
    state: absent
    packages:
      - nvidia-container-toolkit
      - nvidia-container-runtime

# https://github.com/NVIDIA/k8s-device-plugin#configure-containerd
# https://github.com/k3s-io/k3s/issues/4391
- name: Insert/Update "Match User" configuration block in /etc/ssh/sshd_config
  ansible.builtin.blockinfile:
    state: absent
    path: /var/lib/rancher/k3s/agent/etc/containerd/config.toml
    block: |

      [plugins."io.containerd.grpc.v1.cri"]
        [plugins."io.containerd.grpc.v1.cri".containerd]
          default_runtime_name = "nvidia"

          [plugins."io.containerd.grpc.v1.cri".containerd.runtimes]
            [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.nvidia]
              privileged_without_host_devices = false
              runtime_engine = ""
              runtime_root = ""
              runtime_type = "io.containerd.runc.v2"
              [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.nvidia.options]
                BinaryName = "/usr/bin/nvidia-container-runtime"
